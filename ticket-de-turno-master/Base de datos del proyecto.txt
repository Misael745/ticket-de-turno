CREATE DATABASE IF NOT EXISTS ticket_sistema 
  CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
USE ticket_sistema;

-- =========================
-- CATÁLOGOS BÁSICOS
-- =========================
CREATE TABLE municipios (
  id_municipio SMALLINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  municipio VARCHAR(100) NOT NULL UNIQUE
);

CREATE TABLE niveles_educativos (
  id_nivel TINYINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  nivel VARCHAR(60) NOT NULL UNIQUE
);

CREATE TABLE asuntos (
  id_asunto SMALLINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  descripcion VARCHAR(200) NOT NULL UNIQUE
);

CREATE TABLE oficinas_regionales (
  id_oficina SMALLINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  oficina VARCHAR(150) NOT NULL,
  id_municipio SMALLINT UNSIGNED NOT NULL,
  FOREIGN KEY (id_municipio) REFERENCES municipios(id_municipio)
);

-- =========================
-- HORARIOS DE ATENCIÓN
-- =========================
CREATE TABLE horarios_atencion (
  id_horario SMALLINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  id_oficina SMALLINT UNSIGNED NOT NULL,
  dia_semana ENUM('lunes','martes','miercoles','jueves','viernes','sabado','domingo'),
  hora_apertura TIME NOT NULL,
  hora_cierre TIME NOT NULL,
  max_turnos_dia SMALLINT UNSIGNED DEFAULT 50,
  FOREIGN KEY (id_oficina) REFERENCES oficinas_regionales(id_oficina)
);

-- =========================
-- CONTROL DE TURNOS POR MUNICIPIO
-- =========================
CREATE TABLE contador_turnos (
  id_municipio SMALLINT UNSIGNED PRIMARY KEY,
  ultimo_turno SMALLINT UNSIGNED DEFAULT 0,
  fecha_ultimo_turno DATE,
  FOREIGN KEY (id_municipio) REFERENCES municipios(id_municipio)
);

-- =========================
-- ADMINISTRADORES
-- =========================
CREATE TABLE administradores (
  id_admin INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  usuario VARCHAR(50) NOT NULL UNIQUE,
  password CHAR(60) NOT NULL,
  nombre VARCHAR(150) NOT NULL,
  rol ENUM('admin', 'usuario') DEFAULT 'usuario'
);

-- =========================
-- SOLICITANTES
-- =========================
CREATE TABLE solicitantes (
  id_solicitante INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  nombre_tramitante VARCHAR(120) NOT NULL,
  nombre_solicitante VARCHAR(100) NOT NULL,
  paterno_solicitante VARCHAR(60) NOT NULL,
  materno_solicitante VARCHAR(60),
  curp CHAR(18) NOT NULL UNIQUE,
  telefono CHAR(10),
  celular CHAR(10) NOT NULL,
  correo VARCHAR(150),
  fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_curp (curp)
);

-- =========================
-- TURNOS - TABLA PRINCIPAL
-- =========================
CREATE TABLE turnos (
  id_turno INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  id_solicitante INT UNSIGNED NOT NULL,
  id_oficina SMALLINT UNSIGNED NOT NULL,
  numero_turno SMALLINT UNSIGNED NOT NULL,
  fecha_solicitud TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  hora_solicitud TIME,
  id_nivel TINYINT UNSIGNED NOT NULL,
  id_asunto SMALLINT UNSIGNED NOT NULL,
  estado ENUM('pendiente', 'resuelto', 'cancelado') DEFAULT 'pendiente',
  codigo_qr VARCHAR(255) NOT NULL UNIQUE,
  observaciones TEXT,
  
  FOREIGN KEY (id_solicitante) REFERENCES solicitantes(id_solicitante),
  FOREIGN KEY (id_oficina) REFERENCES oficinas_regionales(id_oficina),
  FOREIGN KEY (id_nivel) REFERENCES niveles_educativos(id_nivel),
  FOREIGN KEY (id_asunto) REFERENCES asuntos(id_asunto),
  
  INDEX idx_oficina_turno (id_oficina, numero_turno),
  INDEX idx_estado (estado),
  INDEX idx_fecha_hora (fecha_solicitud, hora_solicitud)
);
